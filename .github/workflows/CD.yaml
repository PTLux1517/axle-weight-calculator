name: CD

on:
  push:
    branches:
      - main
    paths-ignore:
      - 'README.md'
      - '.gitignore'

jobs:
  deploy:
    needs: cleanup
    runs-on: ubuntu-latest
    permissions:
      pages: write
    timeout-minutes: 5
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
      - name: Setup bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
      - name: Build
        run: |
          echo "#####################"
          echo "Preparing environment"
          echo "#####################"
          echo
          echo "#######################"
          echo "Installing dependencies"
          echo "#######################"
          bun install || { echo "Install dependencies failed"; exit 1; }
          echo
          echo "######################################"
          echo "Environment preparation was successful"
          echo "######################################"
          echo
          echo "--------------------------------------"
          echo
          echo "###############################"
          echo "Building axle-weight-calculator"
          echo "###############################"
          echo
          echo "###############"
          echo "Running bun"
          echo "###############"
          bun run build || { echo "Webpack failed"; exit 1; }
          echo
          echo "####################"
          echo "Build was successful"
          echo "####################"
          exit 0
      - name: Push build to gh-pages branch
        run: |
          git config --global user.name $user_name
          git config --global user.email $user_email
          git remote set-url origin https://${github_token}@github.com/${repository}
          npm run deploy
        env:
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
          github_token: ${{ secrets.GH_PAGES_TOKEN }}
          repository: 'PTLux1517/axle-weight-calculator'
      - name: Deploy gh-pages branch #see api docs here: https://docs.github.com/en/rest/pages/pages?apiVersion=2022-11-28#create-a-github-pages-site
        run: |
          curl -L \
          -X POST \
          -H "Accept: application/vnd.github+json" \
          -H "Authorization: Bearer ${{ secrets.GH_PAGES_TOKEN }}" \
          -H "X-GitHub-Api-Version: 2022-11-28" \
          https://api.github.com/repos/PTLux1517/axle-weight-calculator/pages \
          -d '{"source":{"branch":"gh-pages"}}'